<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Church Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #34a853; --danger: #d93025; --bg: #f1f3f4; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); padding: 15px; margin: 0; color: #202124; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-top: 10px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        h3 { font-size: 13px; color: #5f6368; margin: 0; text-transform: uppercase; }
        
        select, input { padding: 8px; border-radius: 6px; border: 1px solid #dadce0; font-size: 13px; }
        .chart-box { height: 250px; width: 100%; margin-bottom: 20px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 10px; border: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; font-weight: 600; }
        .num { text-align: center; font-weight: bold; }
        tr.total-row { background: #f1f3f4; font-weight: bold; }
        
        .drill-link { text-decoration: none; cursor: pointer; color: inherit; border-bottom: 1px dashed #ccc; }
        .drill-link:hover { border-bottom-style: solid; color: var(--primary); }

        #nameModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; }
        .modal-content { background:white; max-width:600px; margin:40px auto; padding:20px; border-radius:12px; max-height:85vh; display:flex; flex-direction:column; }
    </style>
</head>
<body>

    <div class="grid">
        <div class="card">
            <div class="header-flex">
                <h3>Attendance by City</h3>
                <span id="ltmLabel" style="font-size: 11px; color: var(--primary);"></span>
            </div>
            <div class="chart-box"><canvas id="ltmChart"></canvas></div>
            <table>
                <thead><tr><th>City Name</th><th class="num">Attendance</th></tr></thead>
                <tbody id="ltmBody"></tbody>
                <tfoot id="ltmFoot"></tfoot>
            </table>
        </div>

        <div class="card">
            <div class="header-flex">
                <h3>Status by City</h3>
                <span id="clLabel" style="font-size: 11px; color: var(--success);"></span>
            </div>
            <div class="chart-box"><canvas id="clChart"></canvas></div>
            <table>
                <thead><tr><th>City Name</th><th class="num">Active</th><th class="num">Missing</th></tr></thead>
                <tbody id="clBody"></tbody>
                <tfoot id="clFoot"></tfoot>
            </table>
        </div>
    </div>

    <div id="nameModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="modalTitle" style="font-size:16px; color:#1a73e8; margin:0;"></h2>
                <button onclick="closeModal()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            
            <div style="padding: 15px 0; display: flex; gap: 10px;">
                <select id="modalAreaFilter" onchange="filterModalList()" style="flex: 1;">
                    <option value="All">All Areas</option>
                </select>
                <input type="text" id="modalSearch" placeholder="Search name..." onkeyup="filterModalList()" style="flex: 1;">
            </div>

            <div style="overflow-y:auto; flex:1; border-top:1px solid #eee;">
                <table style="width:100%;">
                    <thead><tr><th>Name</th><th>Area</th><th>Shepherd</th></tr></thead>
                    <tbody id="modalBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbyWD724YvzDPZXOZjkvTNiV30qE2doD2CrV8cKwELQNB4-h2dlW1x82vMJn0APAkm_C/exec";
    let rawData, currentModalList = [], chartLTM, chartCL;

    window.onload = async () => {
        const response = await fetch(API + "?action=getAnalytics");
        rawData = await response.json();
        updateUI();
    };

    function updateUI() {
        const latest = rawData.monthly[0];
        const cities = [...new Set([...latest.activeNames, ...latest.missingNames].map(p => p.city))].sort();
        
        document.getElementById('ltmLabel').innerText = latest.month;
        document.getElementById('clLabel').innerText = latest.month;

        let totalAct = 0, totalMis = 0;

        // Populate LTM Table
        document.getElementById('ltmBody').innerHTML = cities.map(city => {
            const count = latest.activeNames.filter(p => p.city === city).length;
            totalAct += count;
            return `<tr><td>${city}</td><td class="num">${count}</td></tr>`;
        }).join('');
        document.getElementById('ltmFoot').innerHTML = `<tr class="total-row"><td>TOTAL</td><td class="num">${totalAct}</td></tr>`;

        // Populate Church Life Table
        document.getElementById('clBody').innerHTML = cities.map(city => {
            const act = latest.activeNames.filter(p => p.city === city).length;
            const mis = latest.missingNames.filter(p => p.city === city).length;
            totalMis += mis;
            return `<tr>
                <td>${city}</td>
                <td class="num"><a class="drill-link" style="color:var(--success)" onclick="openModal('${city}', 'active')">${act}</a></td>
                <td class="num"><a class="drill-link" style="color:var(--danger)" onclick="openModal('${city}', 'missing')">${mis}</a></td>
            </tr>`;
        }).join('');
        document.getElementById('clFoot').innerHTML = `<tr class="total-row"><td>TOTAL</td><td class="num">${totalAct}</td><td class="num">${totalMis}</td></tr>`;

        renderCharts(cities, latest);
    }

    function openModal(city, type) {
        const latest = rawData.monthly[0];
        const fullList = type === 'active' ? latest.activeNames : latest.missingNames;
        currentModalList = fullList.filter(p => p.city === city);
        
        // Setup Area Filter for this specific city
        const areas = [...new Set(currentModalList.map(p => p.area))].sort();
        const areaSelect = document.getElementById('modalAreaFilter');
        areaSelect.innerHTML = '<option value="All">All Areas</option>' + areas.map(a => `<option value="${a}">${a}</option>`).join('');
        
        document.getElementById('modalTitle').innerText = `${city} - ${type === 'active' ? 'Active' : 'Missing'}`;
        document.getElementById('modalSearch').value = '';
        filterModalList();
        document.getElementById('nameModal').style.display = 'block';
    }

    function filterModalList() {
        const selectedArea = document.getElementById('modalAreaFilter').value;
        const search = document.getElementById('modalSearch').value.toLowerCase();
        
        const filtered = currentModalList.filter(p => 
            (selectedArea === "All" || p.area === selectedArea) &&
            (p.name.toLowerCase().includes(search))
        );

        document.getElementById('modalBody').innerHTML = filtered.map(p => `
            <tr><td>${p.name}</td><td>${p.area}</td><td><span style="font-size:11px; color:var(--primary)">${p.sheperd}</span></td></tr>
        `).join('');
    }

    function closeModal() { document.getElementById('nameModal').style.display = 'none'; }

    function renderCharts(cities, data) {
        const actData = cities.map(c => data.activeNames.filter(p => p.city === c).length);
        const misData = cities.map(c => data.missingNames.filter(p => p.city === c).length);

        if (chartLTM) chartLTM.destroy();
        chartLTM = new Chart(document.getElementById('ltmChart'), {
            type: 'bar',
            data: { labels: cities, datasets: [{ label: 'Attendance', data: actData, backgroundColor: '#1a73e8' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });

        if (chartCL) chartCL.destroy();
        chartCL = new Chart(document.getElementById('clChart'), {
            type: 'doughnut',
            data: { 
                labels: ['Active', 'Missing'], 
                datasets: [{ data: [actData.reduce((a,b)=>a+b,0), misData.reduce((a,b)=>a+b,0)], backgroundColor: ['#34a853', '#ea4335'] }] 
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }
</script>
</body>
</html>