<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Video Training Registration</title>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --border: #cbd5e1; --error: #dc2626; --success: #16a34a; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); padding: 20px; color: #1e293b; }
        .form-card { max-width: 700px; margin: 0 auto; background: white; padding: 35px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); text-align: center; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 14px; font-weight: 600; color: #475569; margin-bottom: 8px; }
        select, input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; box-sizing: border-box; }
        
        #pt-container { 
            display: none; 
            background: #f1f5f9; 
            padding: 20px; 
            border-radius: 12px; 
            margin-top: 20px; 
            max-height: 400px; 
            overflow-y: auto; 
            border: 2px solid #cbd5e1;
        }
        
        .counter-badge { background: #dbeafe; color: var(--primary); padding: 8px 16px; border-radius: 30px; font-size: 13px; font-weight: 700; margin-bottom: 15px; position: sticky; top: 0; z-index: 10; display: inline-block; }
        .date-section { margin-bottom: 15px; background: white; padding: 10px 15px; border-radius: 8px; border-left: 5px solid var(--primary); }
        .date-label { font-weight: 800; font-size: 15px; display: block; margin-bottom: 10px; color: var(--primary); }
        .check-item { display: flex; align-items: center; padding: 8px 12px; cursor: pointer; border-radius: 6px; }
        .check-item input { width: 18px; height: 18px; margin-right: 15px; }
        
        .error-text { background-color: #fee2e2; color: var(--error); padding: 12px; border-radius: 8px; font-size: 14px; display: none; font-weight: 700; margin-top: 20px; border: 1px solid var(--error); text-align: center; }
        .btn-submit { width: 100%; background: var(--primary); color: white; padding: 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.3s; }
        .btn-submit:disabled { background: #94a3b8; cursor: not-allowed; }
        .success-msg { color: var(--success); text-align: center; display: none; margin-top: 20px; font-weight: bold; }
        .row-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>

<div class="form-card">
    <h2>Video Trainee Registration</h2>
    <form id="traineeForm">
        <div class="form-group">
            <label>Trainee Name</label>
            <select id="name" required onchange="handleNameChange()">
                <option value="">Connecting...</option>
            </select>
        </div>

        <div class="row-grid">
            <div class="form-group"><label>Language</label><input type="text" id="language" readonly style="background:#f1f5f9;"></div>
            <div class="form-group">
                <label>Location</label>
                <select id="location" required>
                    <option value="">Select Location</option>
                    <option value="Hebbagodi">Hebbagodi</option>
                    <option value="Indira Nagar">Indira Nagar</option>
                </select>
            </div>
        </div>

        <div class="form-group"><label>Training Type</label><input type="text" id="trainingType" readonly style="background:#f1f5f9;"></div>

        <div id="pt-container">
            <div class="counter-badge">Sessions Selected: <span id="count-val">0</span> / 6 Min</div>
            
            <div class="date-section">
                <span class="date-label">January 24</span>
                <label class="check-item"><input type="checkbox" name="msg" value="1" onchange="updateCounter()"> Msg 1</label>
                <label class="check-item"><input type="checkbox" name="msg" value="2" onchange="updateCounter()"> Msg 2</label>
                <label class="check-item"><input type="checkbox" name="msg" value="3" onchange="updateCounter()"> Msg 3</label>
            </div>
            <div class="date-section">
                <span class="date-label">January 25</span>
                <label class="check-item"><input type="checkbox" name="msg" value="4" onchange="updateCounter()"> Msg 4</label>
                <label class="check-item"><input type="checkbox" name="msg" value="5" onchange="updateCounter()"> Msg 5</label>
                <label class="check-item"><input type="checkbox" name="msg" value="6" onchange="updateCounter()"> Msg 6</label>
            </div>
            <div class="date-section">
                <span class="date-label">January 26</span>
                <label class="check-item"><input type="checkbox" name="msg" value="7" onchange="updateCounter()"> Msg 7</label>
                <label class="check-item"><input type="checkbox" name="msg" value="8" onchange="updateCounter()"> Msg 8</label>
                <label class="check-item"><input type="checkbox" name="msg" value="9" onchange="updateCounter()"> Msg 9</label>
            </div>
            <div class="date-section">
                <span class="date-label">February 1</span>
                <label class="check-item"><input type="checkbox" name="msg" value="10" onchange="updateCounter()"> Msg 10</label>
                <label class="check-item"><input type="checkbox" name="msg" value="11" onchange="updateCounter()"> Msg 11</label>
                <label class="check-item"><input type="checkbox" name="msg" value="12" onchange="updateCounter()"> Msg 12</label>
            </div>
        </div>

        <p id="error-min" class="error-text">‚ö†Ô∏è Warning: At least 6 sessions are mandatory for Part Time.</p>
        <button type="submit" class="btn-submit" id="submitBtn">Update Registration</button>
        <p class="success-msg" id="msg">üéâ Values Updated in Sheet!</p>
    </form>
</div>

<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzEzxzp1gcovMEfkrBHcz6iiemQ4QIhjVM5d8set6ZCW2LWYPHjG90-mR35r-Kya2lrTw/exec";
    let traineeMasterData = {};
    let selectedRowId = null;

    window.onload = function() {
        const script = document.createElement('script');
        script.src = `${scriptURL}?action=getDropdowns&callback=setupDropdowns`;
        document.body.appendChild(script);
    };

    window.setupDropdowns = function(data) {
        if (!data || !data.trainees) return;
        traineeMasterData = data.trainees; 
        const nameSelect = document.getElementById('name');
        nameSelect.innerHTML = '<option value="">-- Choose Trainee --</option>';
        Object.keys(traineeMasterData).sort().forEach(name => {
            nameSelect.innerHTML += `<option value="${name}">${name}</option>`;
        });
    };

    function handleNameChange() {
        const selectedName = document.getElementById('name').value;
        const locationDropdown = document.getElementById('location');
        const checkboxes = document.querySelectorAll('input[name="msg"]');
        
        locationDropdown.value = "";
        checkboxes.forEach(cb => cb.checked = false);

        if (selectedName && traineeMasterData[selectedName]) {
            const trainee = traineeMasterData[selectedName];
            document.getElementById('language').value = trainee.language || "";
            document.getElementById('trainingType').value = trainee.type || "";
            selectedRowId = trainee.rowNum; 

            if (trainee.location) {
                locationDropdown.value = trainee.location.toString().trim();
            }

            const container = document.getElementById('pt-container');
            if (trainee.type === 'PT') {
                container.style.display = 'block';
                if (trainee.ftMessages) {
                    const savedValues = trainee.ftMessages.toString().split(',').map(s => s.trim());
                    checkboxes.forEach(cb => {
                        if (savedValues.includes(cb.value)) cb.checked = true;
                    });
                }
            } else {
                container.style.display = 'none';
            }
            updateCounter();
        }
    }

    function updateCounter() {
        const count = document.querySelectorAll('input[name="msg"]:checked').length;
        document.getElementById('count-val').innerText = count;
        if(count >= 6) document.getElementById('error-min').style.display = 'none';
    }

    document.getElementById('traineeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const name = document.getElementById('name').value;
        const type = document.getElementById('trainingType').value;
        const location = document.getElementById('location').value;
        const selectedMsgs = Array.from(document.querySelectorAll('input[name="msg"]:checked')).map(cb => cb.value);
        const finalMsgs = (type === 'FT') ? "All" : selectedMsgs.join(', ');

        if (type === 'PT' && selectedMsgs.length < 6) {
            document.getElementById('error-min').style.display = 'block';
            return;
        }

        const btn = document.getElementById('submitBtn');
        btn.innerText = "Updating...";
        btn.disabled = true;

        fetch(scriptURL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify({
                action: "add",
                rowId: selectedRowId,
                name: name,
                location: location,
                ftMessages: finalMsgs
            }) 
        })
        .then(() => {
            // Update the local data object so the new values "stick"
            traineeMasterData[name].location = location;
            traineeMasterData[name].ftMessages = finalMsgs;

            btn.innerText = "Saved Successfully!";
            btn.style.background = "#16a34a";
            document.getElementById('msg').style.display = "block";
            
            setTimeout(() => { 
                btn.innerText = "Update Registration";
                btn.style.background = "#2563eb";
                btn.disabled = false;
                document.getElementById('msg').style.display = "none"; 
            }, 3000);
        });
    });
</script>
</body>
</html>

