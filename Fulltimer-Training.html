<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full-timers' Training 8th Jan to 10th Jan 2026 Registration</title>
    <style>
        /* Base and Responsive Styles */
        body { font-family: Arial, sans-serif; padding: 10px; background-color: #f4f4f9; }
        .container { 
            max-width: 600px; 
            width: 100%; 
            margin: 20px auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); 
            position: relative; /* Needed for the loader overlay */
        }
        h1 { text-align: center; color: #007bff; } 
        h2 { text-align: center; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-top: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        
        /* Ensures inputs span the full width of the container */
        input[type="text"], input[type="number"], input[type="date"], input[type="tel"], select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; 
            font-size: 1em; 
        }

        /* Aligns Hour and Minute dropdowns side-by-side */
        .time-group { display: flex; justify-content: space-between; }
        .time-group select { width: 48%; }
        
        .submit-button {
            background-color: #5cb85c;
            color: white;
            padding: 12px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em;
            width: 100%;
            margin-top: 20px;
        }
        /* Style for highlighting invalid fields */
        input:invalid:not(:focus), select:invalid:not(:focus) {
            border-color: red !important;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }
        /* Styling for radio buttons */
        #accommodation_type_group label, #extra_stay_bed_group label, #reg_type_group label {
            display: block; 
            margin-bottom: 8px; 
            font-weight: normal; 
            padding: 5px 0;
            border: 1px solid #eee;
            border-radius: 4px;
            cursor: pointer;
        }
        #accommodation_type_group input[type="radio"], #extra_stay_bed_group input[type="radio"], #reg_type_group input[type="radio"] {
            width: auto; 
            margin-right: 10px; 
            margin-left: 5px;
        }

        /* Spacing for Extra Stay Dates (now Nights) */
        .extra-stay-date-group {
            margin-bottom: 20px; 
            padding: 10px; 
            background-color: #f9f9f9; 
            border: 1px solid #e0e0e0; 
            border-radius: 6px;
        }
        .extra-stay-date-group label {
            font-weight: bold; 
            margin-bottom: 8px; 
            margin-top: 0; 
            font-size: 0.95em;
            color: #555;
            display: block;
        }
        .extra-stay-date-group select { 
            margin-top: 5px; 
            margin-bottom: 0; 
        }

        /* Styling for the Family Panel */
        #family_panel {
            padding: 15px;
            border: 2px solid #007bff;
            border-radius: 8px;
            margin-top: 15px;
            background-color: #e6f0ff;
        }
        #family_panel h3 {
            margin-top: 0;
            color: #007bff;
            border-bottom: 1px dashed #007bff;
            padding-bottom: 5px;
        }
        .family-member-box {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            background-color: #fff;
            position: relative;
        }
        .add-member-button, .remove-member-button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .add-member-button {
            background-color: #007bff;
            color: white;
            width: 100%;
        }
        .remove-member-button {
            background-color: #dc3545;
            color: white;
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            font-size: 0.8em;
        }

        /* --- NEW STYLES FOR LOADER AND RESULT --- */

        #loader-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            text-align: center;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007bff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 25% auto 15px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #result-panel {
            display: none; /* Hidden by default */
            padding: 30px;
            text-align: center;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 1.1em;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>

<div id="loader-overlay">
    <div class="spinner"></div>
    <p style="font-size: 1.2em; color: #007bff;">Submitting Registration...</p>
</div>

<div class="container" id="form-container">
    <h1>Full-Timers' Training 8 Jan to 10 Jan 2026 Registration</h1>
    
    <div id="result-panel"></div>

    <form id="registrationForm" onsubmit="handleFormSubmission(event)">
        
        <h2>Personal Details</h2>
        <div class="form-group"><label for="name">Full Name of Registrant *</label><input type="text" id="name" name="name" required></div>
        <div class="form-group">
            <label for="designation">Brother / Sister *</label>
            <select id="designation" name="designation" required>
                <option value="" disabled selected>Select Designation</option>
                <option value="Brother">Brother</option><option value="Sister">Sister</option>
            </select>
        </div>
        <div class="form-group"><label for="age">Age *</label><input type="number" id="age" name="age" min="18" max="99" required></div>
        <div class="form-group"><label for="mobile">Mobile Number *</label><input type="tel" id="mobile" name="mobile" pattern="[0-9]{10}" placeholder="10 Digits" required></div>
        
        <div class="form-group">
            <label for="language">Language *</label>
            <select id="language" name="language" required onchange="toggleOtherLanguageInput()">
                <option value="" disabled selected>Select Language</option>
                <option value="English">English</option><option value="Hindi">Hindi</option><option value="Tamil">Tamil</option><option value="Telugu">Telugu</option>
                <option value="Malayalam">Malayalam</option><option value="Marathi">Marathi</option><option value="Kannada">Kannada</option>
                <option value="Others">Others</option>
            </select>
        </div>
        <div class="form-group" id="other_language_group" style="display: none;">
            <label for="other_language">Please specify your Language *</label>
            <input type="text" id="other_language" name="other_language">
        </div>
        
        <div class="form-group">
            <label for="state">State *</label>
            <select id="state" name="state" required>
                <option value="" disabled selected>Select State</option>
                <option value="Andhra Pradesh">Andhra Pradesh</option><option value="Arunachal Pradesh">Arunachal Pradesh</option>
                <option value="Assam">Assam</option><option value="Bihar">Bihar</option><option value="Chhattisgarh">Chhattisgarh</option>
                <option value="Goa">Goa</option><option value="Gujarat">Gujarat</option><option value="Haryana">Haryana</option>
                <option value="Himachal Pradesh">Himachal Pradesh</option><option value="Jharkhand">Jharkhand</option><option value="Karnataka">Karnataka</option>
                <option value="Kerala">Kerala</option><option value="Madhya Pradesh">Madhya Pradesh</option><option value="Maharashtra">Maharashtra</option>
                <option value="Manipur">Manipur</option><option value="Meghalaya">Meghalaya</option><option value="Mizoram">Mizoram</option>
                <option value="Nagaland">Nagaland</option><option value="Odisha">Odisha</option><option value="Punjab">Punjab</option>
                <option value="Rajasthan">Rajasthan</option><option value="Sikkim">Sikkim</option><option value="Tamil Nadu">Tamil Nadu</option>
                <option value="Telangana">Telangana</option><option value="Tripura">Tripura</option><option value="Uttar Pradesh">Uttar Pradesh</option>
                <option value="Uttarakhand">Uttarakhand</option><option value="West Bengal">West Bengal</option>
                <optgroup label="Union Territories">
                    <option value="Andaman and Nicobar Islands">Andaman and Nicobar Islands</option><option value="Chandigarh">Chandigarh</option>
                    <option value="Dadra and Nagar Haveli and Daman and Diu">D&N Haveli and Daman & Diu</option><option value="Delhi">Delhi</option>
                    <option value="Lakshadweep">Lakshadweep</option><option value="Puducherry">Puducherry</option>
                </optgroup>
            </select>
        </div>
        <div class="form-group"><label for="locality">Locality (City) *</label><input type="text" id="locality" name="locality" required></div>

        <div class="form-group">
            <label>Registration Type *</label>
            <div id="reg_type_group">
                <label>
                    <input type="radio" name="registration_type" value="Individual" onclick="toggleFamilyFields(false)" required>
                    **Individual** (Only the registrant)
                </label>
                <label>
                    <input type="radio" name="registration_type" value="Family" onclick="toggleFamilyFields(true)" required>
                    **Family** (Registrant + Spouse/Family Members)
                </label>
            </div>
        </div>

        <div id="family_panel" style="display: none;">
            <h3>Additional Family Member Details</h3>
            <p style="font-size: 0.8em; font-style: italic;">Provide details for all accompanying family members.</p>
            
            <input type="hidden" name="family_data_summary" id="family_data_summary">
            
            <div id="family_member_list">
                </div>
            
            <button type="button" onclick="addFamilyMember()" class="add-member-button">‚ûï Add Another Member</button>
        </div>
        <h2>Responsible Brother Details *</h2>
        <div class="form-group"><label for="resp_name">Responsible Brother's Name *</label><input type="text" id="resp_name" name="resp_name" required></div>
        <div class="form-group"><label for="resp_mobile">Responsible Br Mobile Number *</label><input type="tel" id="resp_mobile" name="resp_mobile" pattern="[0-9]{10}" placeholder="10 Digits" required></div>

        <h2>Travel & Accommodation</h2>
        
        <div class="form-group"><label for="arrival_date">Date of Arrival *</label><input type="date" id="arrival_date" name="arrival_date" required></div>
        
        <div class="form-group">
            <label>Time of Arrival (24-Hour) *</label>
            <div class="time-group">
                <select id="arrival_hour" name="arrival_hour" required>
                    <option value="" disabled selected>Hour (00-23)</option>
                    </select>
                <select id="arrival_minute" name="arrival_minute" required>
                    <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                </select>
            </div>
        </div>

        <div class="form-group"><label for="departure_date">Date of Departure *</label><input type="date" id="departure_date" name="departure_date" required></div>
        
        <div class="form-group">
            <label>Time of Departure (24-Hour) *</label>
            <div class="time-group">
                <select id="departure_hour" name="departure_hour" required>
                    <option value="" disabled selected>Hour (00-23)</option>
                    </select>
                <select id="departure_minute" name="departure_minute" required>
                    <option value="00">00</option><option value="15">15</option><option value="30">30</option><option value="45">45</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="accommodation_required">Accommodation Required? *</label>
            <select id="accommodation_required" name="accommodation_required" required onchange="toggleAccommodationFields()">
                <option value="" disabled selected>Select Yes/No</option>
                <option value="Yes">Yes</option><option value="No">No</option>
            </select>
        </div>

        <div id="accommodation-panel" style="display: none;">
            
            <div class="form-group">
                <label for="accommodation_type_group">Accommodation Type (Main Stay) *</label>
                <input type="hidden" name="accommodation_type" id="accommodation_type_hidden"> 
                <div id="accommodation_type_group">
                    <label>
                        <input type="radio" name="accommodation_type_radio" value="Non-AC" onclick="document.getElementById('accommodation_type_hidden').value='Non-AC';" >
                        **Non-AC** - 4 or 5 beds per room.
                    </label>
                    <label>
                        <input type="radio" name="accommodation_type_radio" value="AC" onclick="document.getElementById('accommodation_type_hidden').value='AC';" >
                        **AC 800** - 3 beds per room.
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>Extra Stay Nights üåô</label>
                
                <div class="extra-stay-date-group">
                    <label for="extra_nights_before">**Before Training** Extra Nights (Max 2):</label>
                    <select id="extra_nights_before" name="extra_nights_before">
                        <option value="0" selected>0 Nights</option>
                        <option value="1">1 Night (Jan 7th)</option>
                        <option value="2">2 Nights (Jan 6th & 7th)</option>
                    </select>
                </div>

                <div class="extra-stay-date-group">
                    <label for="extra_nights_after">**After Training** Extra Nights (Max 2):</label>
                    <select id="extra_nights_after" name="extra_nights_after">
                        <option value="0" selected>0 Nights</option>
                        <option value="1">1 Night (Jan 10th)</option>
                        <option value="2">2 Nights (Jan 10th & 11th)</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="extra_stay_bed_group">Extra Stay Bed Type (Without Food) *</label>
                <input type="hidden" name="extra_stay_bed" id="extra_stay_bed_hidden" value="None"> 

                <div id="extra_stay_bed_group">
                    <label>
                        <input type="radio" name="extra_stay_bed_radio" value="Non-AC" onclick="document.getElementById('extra_stay_bed_hidden').value='Non-AC';" >
                        **Non-AC** Bed Only (‚Çπ525 per night)
                    </label>
                    <label>
                        <input type="radio" name="extra_stay_bed_radio" value="AC" onclick="document.getElementById('extra_stay_bed_hidden').value='AC';" >
                        **AC** Bed Only (‚Çπ800 per night)
                    </label>
                    <label>
                        <input type="radio" name="extra_stay_bed_radio" value="None" onclick="document.getElementById('extra_stay_bed_hidden').value='None';" checked>
                        **None**
                    </label>
                </div>
            </div>
        </div>
        
        <button type="submit" class="submit-button" id="submit-button">Submit Registration</button>
    </form>
</div>

<script>
    // üõë Apps Script Web App URL
    // NOTE: This URL must be from a deployed script with "Execute as: User accessing the web app" and "Who has access: Anyone"
    //const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx7JfCjR-uMbP0w5W85vDtjfwYGI4Si4S1jvh_IPhcS_IT-YMUV_IBHoKaekUQAZCwqnQ/exec';
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwcqHt8PXYe5loI2rtxHh01Sw0M207WVsJ4-RfSUr_d7HBxhsZztYXV59t19PhZCNy2hw/exec';
    
    // const TRAINING_START = new Date('2026-01-08T00:00:00'); // Removed: not used
    // const TRAINING_END = new Date('2026-01-10T00:00:00'); // Removed: not used
    let memberCount = 0; // Tracks the number of family members added

    // --- Template for a New Family Member (Inputs only, using placeholders) ---
    function getMemberFieldsTemplate(count) {
        const id = count;
        return `
            <div class="family-member-box" id="member_box_${id}">
                <button type="button" class="remove-member-button" onclick="removeFamilyMember(${id})">X Remove</button>
                
                <p style="font-weight: bold; margin-bottom: 10px;">Family Member ${count}</p>
                
                <div class="form-group">
                    <input type="text" id="family_name_${id}" name="family_name_${id}" data-required-family="true" placeholder="Full Name of Member *">
                </div>
                
                <div class="form-group">
                    <select id="family_designation_${id}" name="family_designation_${id}" data-required-family="true">
                        <option value="" disabled selected>Brother / Sister *</option>
                        <option value="Brother">Brother</option>
                        <option value="Sister">Sister</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <input type="number" id="family_age_${id}" name="family_age_${id}" min="1" max="99" data-required-family="true" placeholder="Age *">
                </div>
                
                <div class="form-group">
                    <select id="family_language_${id}" name="family_language_${id}" data-required-family="true" onchange="toggleFamilyOtherLanguageInput(${id})">
                        <option value="" disabled selected>Language *</option>
                        <option value="English">English</option>
                        <option value="Hindi">Hindi</option> <option value="Tamil">Tamil</option>
                        <option value="Telugu">Telugu</option>
                        <option value="Malayalam">Malayalam</option>
                        <option value="Marathi">Marathi</option>
                        <option value="Kannada">Kannada</option>
                        <option value="Others">Others</option>
                    </select>
                </div>
                <div class="form-group" id="family_other_language_group_${id}" style="display: none;">
                    <input type="text" id="family_other_language_${id}" name="family_other_language_${id}" placeholder="Please specify Language *">
                </div>

            </div>
        `;
    }

    // --- Dynamic Member Functions ---

    function addFamilyMember() {
        memberCount++;
        const container = document.getElementById('family_member_list');
        container.insertAdjacentHTML('beforeend', getMemberFieldsTemplate(memberCount));
        
        // Ensure new fields are marked as required if Family panel is visible
        toggleFamilyRequired(true); 
    }

    function removeFamilyMember(id) {
        const box = document.getElementById(`member_box_${id}`);
        if (box) {
            box.remove();
        }
        // If the last member is removed, ensure required status is handled correctly.
        if (document.getElementById('family_member_list').children.length === 0) {
            memberCount = 0;
        }
    }
    
    // Function to set required attribute on dynamic fields
    function toggleFamilyRequired(isRequired) {
        document.querySelectorAll('[data-required-family]').forEach(field => {
            field.required = isRequired;
        });
    }

    // Toggle Family Panel visibility
    function toggleFamilyFields(isFamilySelected) {
        const panel = document.getElementById('family_panel');
        
        if (isFamilySelected) {
            panel.style.display = 'block';
            if (document.getElementById('family_member_list').children.length === 0) { // Check for existing members using the list children count
                 addFamilyMember(); // Automatically add the first member if none exist
            } else {
                toggleFamilyRequired(true);
            }
        } else {
            panel.style.display = 'none';
            toggleFamilyRequired(false);
            
            // Clear and remove all family members when switching back to Individual
            document.getElementById('family_member_list').innerHTML = '';
            memberCount = 0; 
        }
    }

    // --- FUNCTION: Toggle Main Registrant "Other Language" Text Input ---
    function toggleOtherLanguageInput() {
        const languageSelector = document.getElementById('language');
        const otherLangGroup = document.getElementById('other_language_group');
        const otherLangInput = document.getElementById('other_language');

        if (languageSelector.value === 'Others') {
            otherLangGroup.style.display = 'block';
            otherLangInput.required = true;
        } else {
            otherLangGroup.style.display = 'none';
            otherLangInput.required = false;
            otherLangInput.value = ''; // Clear value if hidden
        }
    }

    // --- NEW FUNCTION: Toggle Family Member "Other Language" Text Input ---
    function toggleFamilyOtherLanguageInput(id) {
        const languageSelector = document.getElementById(`family_language_${id}`);
        const otherLangGroup = document.getElementById(`family_other_language_group_${id}`);
        const otherLangInput = document.getElementById(`family_other_language_${id}`);

        if (languageSelector.value === 'Others') {
            otherLangGroup.style.display = 'block';
            otherLangInput.required = true;
        } else {
            otherLangGroup.style.display = 'none';
            otherLangInput.required = false;
            otherLangInput.value = ''; // Clear value if hidden
        }
    }


    // Function to show/hide the accommodation fields (Existing)
    function toggleAccommodationFields() {
        const selector = document.getElementById('accommodation_required');
        const panel = document.getElementById('accommodation-panel');
        
        const mainAcc = document.getElementById('accommodation_type_hidden');
        const extraAcc = document.getElementById('extra_stay_bed_hidden');

        if (selector.value === 'Yes') {
            panel.style.display = 'block';
            mainAcc.required = true;
            extraAcc.required = true;
            
        } else {
            panel.style.display = 'none';
            mainAcc.required = false;
            extraAcc.required = false;
            
            // Reset values to their defaults when hidden
            mainAcc.value = '';
            extraAcc.value = 'None'; // Explicitly set to 'None' default
            
            document.querySelectorAll('input[name="accommodation_type_radio"]:checked').forEach(radio => radio.checked = false);
            // Ensure the 'None' radio is checked when hidden
            const noneRadio = document.querySelector('input[name="extra_stay_bed_radio"][value="None"]');
            if (noneRadio) {
                noneRadio.checked = true;
            }
        }
    }
    
    // --- NEW FUNCTION: Aggregates family member data into a single CSV string ---
    function aggregateFamilyData() {
        const familyDataSummary = document.getElementById('family_data_summary');
        const memberList = document.getElementById('family_member_list').children;
        let data = [];
        
        // Loop through all currently displayed family member boxes
        Array.from(memberList).forEach(box => {
            const idMatch = box.id.match(/member_box_(\d+)/);
            if (idMatch) {
                const id = idMatch[1];
                
                // Collect values, defaulting to 'N/A' if empty, though validation should prevent this.
                const name = document.getElementById(`family_name_${id}`).value.trim() || 'N/A';
                const designation = document.getElementById(`family_designation_${id}`).value.trim() || 'N/A';
                const age = document.getElementById(`family_age_${id}`).value.trim() || 'N/A';
                
                let language = document.getElementById(`family_language_${id}`).value.trim();
                const otherLangInput = document.getElementById(`family_other_language_${id}`);
                
                // Use the 'Other Language' input value if 'Others' is selected
                if (language === 'Others' && otherLangInput) {
                    language = otherLangInput.value.trim() || 'Others-Specified';
                } else if (language === '') {
                    language = 'N/A';
                }
                
                // Format: name,designation,age,language
                data.push(`${name},${designation},${age},${language}`);
            }
        });
        
        // Set the hidden field value in the format: "member1,data|member2,data"
        familyDataSummary.value = data.join('|');
    }

    // Main validation function (now called by handleFormSubmission)
    function validateForm() {
        // 1. HTML5 Built-in Validation
        if (!document.getElementById('registrationForm').checkValidity()) {
            return false;
        }

        // 2. Custom JavaScript Validation (Age, Mobile)
        const age = document.getElementById('age').value;
        if (age < 18 || age > 99) {
            alert("Registrant Age must be between 18 and 99."); 
            document.getElementById('age').focus();
            return false;
        }
        
        // Validate all family member ages
        const familyAgeFields = document.querySelectorAll('input[id^="family_age_"]');
        for (const field of familyAgeFields) {
            if (field.required && (field.value < 1 || field.value > 99)) {
                alert(`Family Member Age (${field.value}) must be between 1 and 99.`); 
                field.focus();
                return false;
            }
        }
        
        const mobileSelf = document.getElementById('mobile').value;
        if (mobileSelf.length !== 10) {
            alert("Your Mobile Number must be exactly 10 digits."); 
            document.getElementById('mobile').focus();
            return false;
        }

        const mobileResp = document.getElementById('resp_mobile');
        if (mobileResp.value && mobileResp.value.length !== 10) {
            alert("Responsible Brother's Mobile Number must be exactly 10 digits."); 
            mobileResp.focus();
            return false;
        }
        
        // 3. Date Validation: Departure must be after Arrival
        const arrivalDate = new Date(document.getElementById('arrival_date').value);
        const departureDate = new Date(document.getElementById('departure_date').value);
        
        if (departureDate < arrivalDate) {
            alert("Date of Departure cannot be before the Date of Arrival."); 
            document.getElementById('departure_date').focus();
            return false;
        }

        // --- EXTRA STAY VALIDATION ---
        const accRequired = document.getElementById('accommodation_required').value;
        
        if (accRequired === 'Yes') {
            const extraNightsBefore = parseInt(document.getElementById('extra_nights_before').value, 10);
            const extraNightsAfter = parseInt(document.getElementById('extra_nights_after').value, 10);
            const totalExtraNights = extraNightsBefore + extraNightsAfter;
            const extraStayType = document.getElementById('extra_stay_bed_hidden').value;
            
            // Check if accommodation type (main stay) is selected
            if (!document.querySelector('input[name="accommodation_type_radio"]:checked')) {
                alert("Please select an Accommodation Type (Non-AC or AC) for the main stay."); 
                return false;
            }

            // A. New Rule: If extra stay bed type is AC or Non-AC, but zero nights are selected
            if (extraStayType !== 'None' && totalExtraNights === 0) {
                alert("You have selected an Extra Stay Bed Type, but zero extra nights. Please select 1 or 2 nights before or after the training.");
                return false;
            }

            // B. Previous Rule: If extra nights are selected, but bed type is 'None'
            if (totalExtraNights > 0 && extraStayType === 'None') {
                alert("You have selected extra night(s) but chose 'None' for Extra Stay Bed Type. Please select Non-AC or AC for your extra stay."); 
                return false;
            }
            
            // C. General check (should be covered by the radio button requirement, but good practice)
            if (extraStayType === '') {
                alert("Please select an option for Extra Stay Bed Type."); 
                return false;
            }
        }
        
        return true;
    }

    // --- NEW FUNCTION: Handles the AJAX submission and UI updates ---
    async function handleFormSubmission(event) {
        event.preventDefault(); // Stop default form submission (redirect)
        
        const form = document.getElementById('registrationForm');
        const submitButton = document.getElementById('submit-button');
        const resultPanel = document.getElementById('result-panel');

        // 1. Run form validation
        if (!validateForm()) {
            // Trigger browser's validation messages (for standard required fields)
            form.reportValidity();
            return;
        }
        
        // 2. Aggregate family data into the hidden field before submission
        aggregateFamilyData(); 

        // 3. Disable button and show loader
        submitButton.disabled = true;
        document.getElementById('loader-overlay').style.display = 'block';
        resultPanel.style.display = 'none';

        // 4. Prepare form data
        const formData = new FormData(form);

        try {
            // 5. Send data to Apps Script Web App
            const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: formData
            });

            // 6. Handle response
            let result;
            let success = response.ok; // Checks for 200-299 status code

            if (success) {
                // Try to parse JSON (expected response from updated Apps Script)
                try {
                    result = await response.json();
                } catch (e) {
                    // Fallback for old Apps Script that returns HTML/Text
                    const text = await response.text();
                    if (text.toLowerCase().includes('successful')) {
                        result = { status: 'success', message: 'Registration Successful. Data has been logged.' };
                    } else {
                        // This indicates a bad deployment or non-JSON/non-HTML successful response
                        result = { status: 'error', message: 'An unknown server error occurred. Please ensure your Apps Script is deployed to return JSON.' };
                        success = false;
                    }
                }
            } else {
                // Handles 4xx or 5xx HTTP errors
                result = { status: 'error', message: `Server returned error status: ${response.status}. Please check Apps Script deployment permissions.` };
            }
            
            // 7. Display result
            displayResult(result.status, result.message);

            if (result.status === 'success') {
                form.reset(); // Clear form on success
                toggleFamilyFields(false); // Hide family panel
                toggleAccommodationFields(); // Hide accommodation panel
            }

        } catch (error) {
            // 8. Handle network errors
            console.error('Submission error:', error);
            displayResult('error', 'Network or Fetch error: Could not connect to the server. Check your console for details. (Commonly caused by an invalid Apps Script URL or deployment setting.)');
        } finally {
            // 9. Hide loader and re-enable button (regardless of outcome)
            document.getElementById('loader-overlay').style.display = 'none';
            submitButton.disabled = false;
        }
    }

    function displayResult(status, message) {
        const resultPanel = document.getElementById('result-panel');
        const form = document.getElementById('registrationForm');

        resultPanel.className = status === 'success' ? 'success' : 'error';
        resultPanel.innerHTML = `<h2>${status === 'success' ? '‚úÖ Success!' : '‚ùå Error!'}</h2><p>${message}</p>`;
        
        resultPanel.style.display = 'block';
        
        // Hide form on success, keep it visible on error
        form.style.display = status === 'success' ? 'none' : 'block';
    }
    
    // Initial check on load 
    window.onload = () => {
        // Run script to populate hour dropdowns
        const hourSelectors = [document.getElementById('arrival_hour'), document.getElementById('departure_hour')];
        hourSelectors.forEach(selector => {
            if (selector && selector.options.length === 1) { // Check if only the default option exists
                for(let h=0; h<24; h++){
                    const option = document.createElement('option');
                    const paddedH = h.toString().padStart(2, '0');
                    option.value = paddedH;
                    option.textContent = paddedH;
                    selector.appendChild(option);
                }
            }
        });

        // Initialize dynamic panels
        const isFamilyChecked = document.querySelector('input[name="registration_type"]:checked')?.value === 'Family';
        
        // If family is checked, we add the first member and ensure the conditional inputs are checked
        if(isFamilyChecked) {
             toggleFamilyFields(true); // Call this to handle initial member adding/required state
        }
        
        toggleOtherLanguageInput(); 
        toggleAccommodationFields();
    }; 
</script>
</body>

</html>




