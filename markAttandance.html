<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Attendance</title>
    <style>
        :root { --primary: #1a73e8; --bg: #f8f9fa; --text: #202124; }
        
        * { box-sizing: border-box; } 
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 10px;
            color: var(--text);
        }
        
        .container { max-width: 500px; margin: auto; padding-bottom: 100px; }

        /* Header Card */
        .setup-card { 
            background: white; 
            padding: 20px; 
            border-radius: 16px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }

        .app-title {
            margin: 0 0 15px 0;
            text-align: center;
            font-size: 1.1rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-group { display: flex; flex-direction: column; gap: 10px; }

        input[type="date"], select {
            width: 100%;
            height: 48px;
            padding: 0 12px;
            border-radius: 10px;
            border: 1.5px solid #dadce0;
            background-color: #fff;
            font-size: 16px;
            appearance: none;
            -webkit-appearance: none;
        }

        /* Family Card Styling */
        .family-card { 
            background: white; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            border: 1px solid #dfe1e5; 
            overflow: hidden; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .family-header { 
            background: #f8f9fa; 
            padding: 12px 15px; 
            display: flex; 
            align-items: center; 
            border-bottom: 1px solid #eee; 
            font-weight: bold; 
            color: #5f6368; 
        }

        .family-header input { width: 20px; height: 20px; margin-right: 12px; }

        /* Member Row Alignment Fixed */
        .member-row { 
            display: flex; 
            align-items: center; 
            padding: 12px 15px; 
            border-bottom: 1px solid #f1f3f4; 
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        .member-row:last-child { border-bottom: none; }

        .sno { width: 30px; color: #80868b; font-size: 0.85rem; flex-shrink: 0; }
        
        .name-container { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            justify-content: center;
        }

        .name-text { font-size: 1rem; font-weight: 500; margin-bottom: 2px; }
        
        .info-sub { font-size: 11px; color: #70757a; font-weight: normal; }

        .indiv-check { 
            width: 24px; 
            height: 24px; 
            accent-color: var(--primary); 
            flex-shrink: 0;
            margin-left: 10px;
            pointer-events: none; /* Allows row click to work */
        }

        /* Sticky Button */
        .copy-btn-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            border-top: 1px solid #eee;
            z-index: 1000;
            max-width: 500px;
            margin: auto;
        }

        .copy-btn { 
            width: 100%; 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 16px; 
            border-radius: 12px; 
            font-size: 1rem; 
            font-weight: bold; 
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
            cursor: pointer;
        }
        
        .copy-btn:active { transform: scale(0.98); opacity: 0.9; }

        #toast {
            visibility: hidden;
            min-width: 200px;
            background-color: #323232;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            bottom: 100px;
            transform: translateX(-50%);
            font-size: 14px;
        }

        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 80px; opacity: 0;} to {bottom: 100px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 100px; opacity: 1;} to {bottom: 80px; opacity: 0;} }
    </style>
</head>
<body>

<div class="container">
    <div class="setup-card">
        <h3 class="app-title">Meeting Roster</h3>
        <div class="input-group">
            <input type="date" id="attDate">
            <select id="locDrop" onchange="renderGroupedList()">
                <option value="">-- Select Location --</option>
            </select>
        </div>
    </div>

    <div id="familyList"></div>

    <div class="copy-btn-container">
        <button class="copy-btn" onclick="copyAttendance()">Copy Selected List</button>
    </div>
</div>

<div id="toast">Copied to Clipboard!</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyg_upnTM5VS2VIcjdnkIbYQRohd3tSq0qUYqsi0FtgNJosLyLgK_yEfAUC4_zOCZNM/exec";
    let dataStore = {};

    window.onload = () => {
        document.getElementById('attDate').valueAsDate = new Date();
        fetch(API_URL).then(r => r.json()).then(data => {
            dataStore = data;
            const d = document.getElementById('locDrop');
            d.innerHTML = '<option value="">-- Choose Location --</option>';
            Object.keys(data).forEach(l => d.innerHTML += `<option value="${l}">${l}</option>`);
        });
    };

    function renderGroupedList() {
        const loc = document.getElementById('locDrop').value;
        const area = document.getElementById('familyList');
        area.innerHTML = "";
        if (!loc) return;

        const families = {};
        dataStore[loc].forEach(p => {
            const famKey = p.family || "Individual";
            if (!families[famKey]) families[famKey] = [];
            families[famKey].push(p);
        });

        const sortedFamilyNames = Object.keys(families).sort((a, b) => {
            if (a === "Individual") return 1;
            if (b === "Individual") return -1;
            return a.localeCompare(b);
        });

        sortedFamilyNames.forEach(famName => {
            const isIndividual = famName === "Individual";
            const safeId = famName.replace(/\s+/g, '');
            let html = `<div class="family-card" id="card-${safeId}">`;
            
            if (!isIndividual) {
                html += `
                <div class="family-header">
                    <input type="checkbox" onchange="selectFamily('${famName}', this.checked)">
                    <span>${famName}</span>
                </div>`;
            } else {
                html += `<div class="family-header" style="background:#fff; color:#999; font-size:0.75rem;">
                            <span>Individual Members</span>
                         </div>`;
            }

            families[famName].forEach(p => {
                html += `
                <div class="member-row" onclick="togglePerson(this, '${famName}')">
                    <span class="sno">${p.sno}</span>
                    <div class="name-container">
                        <span class="name-text">${p.name}</span>
                        <span class="info-sub">${p.ageGrp ? p.ageGrp : ''}</span>
                    </div>
                    <input type="checkbox" class="indiv-check" 
                           data-name="${p.name}" 
                           data-fam="${famName}" 
                           data-grp="${p.ageGrp}">
                </div>`;
            });

            html += `</div>`;
            area.innerHTML += html;
        });
    }

    function selectFamily(famName, isChecked) {
        const checkboxes = document.querySelectorAll(`[data-fam="${famName}"]`);
        checkboxes.forEach(cb => cb.checked = isChecked);
    }

    function togglePerson(el, famName) {
        const cb = el.querySelector('.indiv-check');
        cb.checked = !cb.checked;
        if (!cb.checked) {
            const safeId = famName.replace(/\s+/g, '');
            const master = document.querySelector(`#card-${safeId} .family-header input`);
            if (master) master.checked = false;
        }
    }

    function copyAttendance() {
        const checkedBoxes = document.querySelectorAll('.indiv-check:checked');
        if (checkedBoxes.length === 0) return alert("Select names first!");

        let selected = Array.from(checkedBoxes).map(cb => ({
            name: cb.getAttribute('data-name'),
            fam: cb.getAttribute('data-fam'),
            grp: cb.getAttribute('data-grp') ? cb.getAttribute('data-grp').toUpperCase() : ""
        }));

        let finalNames = [];
        let uniqueFamilies = [...new Set(selected.map(p => p.fam))];

        uniqueFamilies.forEach(familyName => {
            let members = selected.filter(p => p.fam === familyName);
            let children = members.filter(m => m.grp === 'CHILD' || m.grp.includes('CHILD'));
            let adults = members.filter(m => m.grp !== 'CHILD' && !m.grp.includes('CHILD'));
            let childText = children.length > 0 ? ` + (${children.map(c => c.name).join(" & ")})` : "";
            let hasS = adults.find(a => a.grp === 'S');

            adults.forEach(adult => {
                let entry = adult.name;
                if (adult.grp === 'S' && children.length > 0) entry += childText;
                else if (adult.grp === 'B' && !hasS && children.length > 0) entry += childText;
                finalNames.push(entry);
            });

            if (adults.length === 0 && children.length > 0) {
                children.forEach(c => finalNames.push(c.name));
            }
        });

        let loc = document.getElementById('locDrop').value;
        let date = document.getElementById('attDate').value;
        let text = `Attendance: ${loc}\nDate: ${date}\n\n`;
        finalNames.forEach((name, i) => { text += `${i + 1}. ${name}\n`; });

        navigator.clipboard.writeText(text).then(() => {
            const toast = document.getElementById("toast");
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        });
    }
</script>
</body>
</html>
