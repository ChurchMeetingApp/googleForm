<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attendance Generator</title>
    <style>
        :root { --primary: #1a73e8; --bg: #f8f9fa; --text: #202124; }
        * { box-sizing: border-box; } 
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: var(--text); }
        .container { max-width: 500px; margin: auto; padding-bottom: 180px; }
        
        h2 { text-align: center; color: var(--primary); margin: 10px 0 20px 0; font-weight: 800; }

        .setup-card, .text-area-card { background: white; padding: 15px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .input-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .full-row { grid-column: span 2; }

        input, select, textarea { 
            width: 100%; padding: 10px; border-radius: 8px; 
            border: 1.5px solid #dadce0; font-size: 13px; outline: none; background: white;
        }
        
        textarea { height: 70px; resize: none; font-family: inherit; }
        label { font-size: 12px; font-weight: bold; color: #5f6368; margin-bottom: 4px; display: block; }

        .select-all-bar {
            position: sticky; top: 0; z-index: 100;
            display: flex; align-items: center; background: #e8f0fe;
            padding: 12px 15px; border-radius: 10px; margin-bottom: 12px;
            font-weight: 600; color: #1967d2; font-size: 0.9rem; cursor: pointer;
        }
        .select-all-bar input { width: 20px; height: 20px; margin-right: 12px; }

        .family-card { background: white; border-radius: 12px; margin-bottom: 15px; border: 1px solid #dfe1e5; overflow: hidden; }
        .family-header { background: #f1f3f4; padding: 10px 15px; display: flex; align-items: center; border-bottom: 1px solid #eee; font-weight: bold; font-size: 0.85rem; }
        .family-header input { width: 18px; height: 18px; margin-right: 12px; }

        .member-row { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 12px 15px; border-bottom: 1px solid #f1f3f4; cursor: pointer; 
        }
        .name-container { flex-grow: 1; text-align: left; }
        .name-text { font-size: 1rem; font-weight: 500; display: block; }
        .age-sub { font-size: 11px; color: #70757a; font-weight: bold; }

        .indiv-check { width: 22px; height: 22px; accent-color: var(--primary); margin-left: 15px; pointer-events: none; flex-shrink: 0; }

        .copy-btn-container { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; border-top: 1px solid #eee; z-index: 1000; max-width: 500px; margin: auto; }
        .copy-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        #toast { visibility: hidden; min-width: 200px; background: #323232; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; left: 50%; bottom: 90px; transform: translateX(-50%); z-index: 2000; }
        #toast.show { visibility: visible; }
    </style>
</head>
<body>

<div class="container">
    <h2>Attendance Generator</h2>

    <div class="setup-card">
        <div class="input-group">
            <div class="filter-grid">
                <input type="date" id="attDate">
                <select id="meetingType">
                    <option value="LTM">LTM</option>
                    <option value="CLTM">CLTM</option>
                    <option value="Prayer Meeting">Prayer Meeting</option>
                    <option value="Sisters Meeting">Sisters Meeting</option>
                    <option value="SGM">SGM</option>
                    <option value="Ministry Meeting">Ministry Meeting</option>
                </select>
                <select id="locFilter" onchange="renderUI()"><option value="">All Locations</option></select>
                <select id="areaFilter" onchange="renderUI()"><option value="">All Areas</option></select>
                <select id="grpFilter" onchange="renderUI()" class="full-row"><option value="">All Groups</option></select>
            </div>
            <input type="text" id="searchFilter" placeholder="Search names..." onkeyup="renderUI()">
        </div>
    </div>

    <div class="select-all-bar" onclick="toggleAllVisible()">
        <input type="checkbox" id="globalSelectAll">
        <span>Select All Visible Members</span>
    </div>

    <div id="familyList">Fetching data...</div>

    <div class="text-area-card">
        <label>Missing Members (Continuous Count)</label>
        <textarea id="missingText" placeholder="Name 1&#10;Name 2"></textarea>
    </div>

    <div class="text-area-card">
        <label>Visiting Members (Restarts from 1)</label>
        <textarea id="visitingText" placeholder="Visitor 1&#10;Visitor 2"></textarea>
    </div>

    <div class="copy-btn-container">
        <button class="copy-btn" onclick="copyAttendance()">Copy Selected List</button>
    </div>
</div>
<div id="toast">Copied to Clipboard!</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyg_upnTM5VS2VIcjdnkIbYQRohd3tSq0qUYqsi0FtgNJosLyLgK_yEfAUC4_zOCZNM/exec"; 
    let masterData = [];

    window.onload = () => {
        document.getElementById('attDate').valueAsDate = new Date();
        fetchData();
    };

    function fetchData() {
        fetch(API_URL).then(r => r.json()).then(data => {
            masterData = data;
            populateFilters();
            renderUI();
        });
    }

    function populateFilters() {
        const locations = [...new Set(masterData.map(p => p.location))].sort();
        const areas = [...new Set(masterData.map(p => p.area))].sort();
        const groups = [...new Set(masterData.map(p => p.ageGrp))].sort();
        const lDrop = document.getElementById('locFilter');
        const aDrop = document.getElementById('areaFilter');
        const gDrop = document.getElementById('grpFilter');
        locations.forEach(l => lDrop.innerHTML += `<option value="${l}">${l}</option>`);
        areas.forEach(a => aDrop.innerHTML += `<option value="${a}">${a}</option>`);
        groups.forEach(g => gDrop.innerHTML += `<option value="${g}">${g}</option>`);
    }

    function toggleAllVisible() {
        const mainCb = document.getElementById('globalSelectAll');
        if(event.target.type !== 'checkbox') mainCb.checked = !mainCb.checked;
        document.querySelectorAll('.indiv-check').forEach(cb => cb.checked = mainCb.checked);
        document.querySelectorAll('.family-header input').forEach(cb => cb.checked = mainCb.checked);
    }

    function renderUI() {
        const container = document.getElementById('familyList');
        const locVal = document.getElementById('locFilter').value;
        const areaVal = document.getElementById('areaFilter').value;
        const grpVal = document.getElementById('grpFilter').value;
        const search = document.getElementById('searchFilter').value.toLowerCase();
        document.getElementById('globalSelectAll').checked = false;
        container.innerHTML = "";

        const filtered = masterData.filter(p => {
            return (!locVal || p.location === locVal) && 
                   (!areaVal || p.area === areaVal) && 
                   (!grpVal || p.ageGrp === grpVal) && 
                   (p.name.toLowerCase().includes(search) || p.family.toLowerCase().includes(search));
        });

        const families = {};
        filtered.forEach(p => {
            const f = p.family || "Individual";
            if (!families[f]) families[f] = [];
            families[f].push(p);
        });

        Object.keys(families).sort((a,b) => (a==="Individual") ? 1 : (b==="Individual") ? -1 : a.localeCompare(b)).forEach(fam => {
            let html = `<div class="family-card">`;
            if (fam !== "Individual") html += `<div class="family-header"><input type="checkbox" onchange="selectFamily(this)"><span>${fam}</span></div>`;
            families[fam].forEach(p => {
                html += `
                <div class="member-row" onclick="togglePerson(this)">
                    <div class="name-container">
                        <span class="name-text">${p.name}</span>
                        <span class="age-sub">Group: ${p.ageGrp}</span>
                    </div>
                    <input type="checkbox" class="indiv-check" data-name="${p.name}" data-fam="${fam}" data-grp="${p.ageGrp}">
                </div>`;
            });
            html += `</div>`;
            container.innerHTML += html;
        });
    }

    function togglePerson(row) { row.querySelector('.indiv-check').checked = !row.querySelector('.indiv-check').checked; }
    function selectFamily(headerCb) { headerCb.closest('.family-card').querySelectorAll('.indiv-check').forEach(cb => cb.checked = headerCb.checked); }

    function copyAttendance() {
        const boxes = document.querySelectorAll('.indiv-check:checked');
        const missingText = document.getElementById('missingText').value.trim();
        const visitingText = document.getElementById('visitingText').value.trim();
        
        if (boxes.length === 0 && missingText === "" && visitingText === "") return alert("No members selected!");

        const mType = document.getElementById('meetingType').value;
        let text = `${mType} Attendance\nDate: ${document.getElementById('attDate').value}\n\n`;
        let count = 1;

        // 1. Process Database Selected Members
        let selected = Array.from(boxes).map(cb => ({
            name: cb.getAttribute('data-name'),
            fam: cb.getAttribute('data-fam'),
            grp: (cb.getAttribute('data-grp') || "").toUpperCase()
        }));

        let uniqueFams = [...new Set(selected.map(p => p.fam))];
        uniqueFams.forEach(f => {
            let members = selected.filter(p => p.fam === f);
            let kids = members.filter(p => p.grp === "CHILD");
            let head = members.find(p => p.grp === "B");
            let spouse = members.find(p => p.grp === "S");
            let others = members.filter(p => p.grp !== "S" && p.grp !== "B" && p.grp !== "CHILD");
            let kidStr = kids.length > 0 ? ` + (${kids.map(k => k.name).join(" & ")})` : "";

            if (head) {
                text += `${count++}. ${head.name}${(!spouse ? kidStr : "")}\n`;
                if (spouse) text += `${count++}. ${spouse.name}${kidStr}\n`;
                others.forEach(o => text += `${count++}. ${o.name}\n`);
            } else if (spouse) {
                text += `${count++}. ${spouse.name}${kidStr}\n`;
                others.forEach(o => text += `${count++}. ${o.name}\n`);
            } else if (others.length > 0) {
                text += `${count++}. ${others[0].name}${kidStr}\n`;
                others.slice(1).forEach(o => text += `${count++}. ${o.name}\n`);
            } else {
                kids.forEach(k => text += `${count++}. ${k.name}\n`);
            }
        });

        // 2. Add Missing Members (Continuous Count)
        if (missingText !== "") {
            missingText.split('\n').forEach(line => {
                if (line.trim()) text += `${count++}. ${line.trim()}\n`;
            });
        }

        // 3. Add Visiting Members (Restart Count from 1)
        if (visitingText !== "") {
            text += `\nVisiting Members:\n`;
            let vCount = 1;
            visitingText.split('\n').forEach(line => {
                if (line.trim()) text += `${vCount++}. ${line.trim()}\n`;
            });
        }

        navigator.clipboard.writeText(text).then(() => {
            const t = document.getElementById("toast");
            t.className = "show";
            setTimeout(() => t.className = "", 3000);
        });
    }
</script>
</body>
</html>
