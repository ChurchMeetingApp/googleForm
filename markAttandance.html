<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Attendance</title>
    <style>
        :root { --primary: #1a73e8; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: auto; }
        
        .setup-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* Family Card Styling */
        .family-card { background: white; border-radius: 12px; margin-bottom: 15px; border: 1px solid #dfe1e5; overflow: hidden; }
        .family-header { background: #f1f3f4; padding: 12px 15px; display: flex; align-items: center; border-bottom: 1px solid #ddd; font-weight: bold; color: var(--primary); }
        .family-header input { width: 20px; height: 20px; margin-right: 12px; cursor: pointer; }
        
        .member-row { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .member-row:last-child { border-bottom: none; }
        .member-row:active { background: #f1f3f4; }
        
        .name-text { flex-grow: 1; font-size: 1rem; color: #202124; }
        .sno { width: 25px; color: #888; font-size: 0.8rem; }
        
        .indiv-check { width: 24px; height: 24px; accent-color: var(--primary); pointer-events: none; }
        
        .copy-btn-container {
    position: sticky;
    bottom: 0;
    background: var(--bg); /* Matches body background */
    padding: 15px 0;
    margin-top: 10px;
    z-index: 1000;
}

.copy-btn { 
    width: 100%; 
    background: var(--primary); 
    color: white; 
    border: none; 
    padding: 18px; 
    border-radius: 12px; 
    font-size: 1.1rem; 
    font-weight: bold; 
    cursor: pointer;
    box-shadow: 0 -4px 10px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.1);
}
    </style>
</head>
<body>

<div class="container">
    <div class="setup-card">
        <h3 style="margin:0 0 10px 0; text-align:center;">Meeting Roster</h3>
        <input type="date" id="attDate" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box;">
        <select id="locDrop" onchange="renderGroupedList()" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-top:10px;">
            <option>Loading locations...</option>
        </select>
    </div>

    <div id="familyList"></div>

    <div class="copy-btn-container">
        <button class="copy-btn" onclick="copyAttendance()">Copy Selected List</button>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyg_upnTM5VS2VIcjdnkIbYQRohd3tSq0qUYqsi0FtgNJosLyLgK_yEfAUC4_zOCZNM/exec";
    let dataStore = {};

    window.onload = () => {
        document.getElementById('attDate').valueAsDate = new Date();
        fetch(API_URL).then(r => r.json()).then(data => {
            dataStore = data;
            const d = document.getElementById('locDrop');
            d.innerHTML = '<option value="">-- Choose Location --</option>';
            Object.keys(data).forEach(l => d.innerHTML += `<option value="${l}">${l}</option>`);
        });
    };


function renderGroupedList() {
    const loc = document.getElementById('locDrop').value;
    const area = document.getElementById('familyList');
    area.innerHTML = "";
    if (!loc) return;

    const families = {};
    dataStore[loc].forEach(p => {
        const famKey = p.family || "Individual";
        if (!families[famKey]) families[famKey] = [];
        families[famKey].push(p);
    });

    // --- SORTING LOGIC ---
    // Get keys and sort them so "Individual" always comes last
    const sortedFamilyNames = Object.keys(families).sort((a, b) => {
        if (a === "Individual") return 1;  // Move 'Individual' to the end
        if (b === "Individual") return -1; // Keep others before 'Individual'
        return a.localeCompare(b);         // Sort families alphabetically
    });

    sortedFamilyNames.forEach(famName => {
        const isIndividual = famName === "Individual";
        const safeId = famName.replace(/\s+/g, '');
        let html = `<div class="family-card" id="card-${safeId}">`;
        
        if (!isIndividual) {
            html += `
            <div class="family-header">
                <input type="checkbox" onchange="selectFamily('${famName}', this.checked)">
                <span>${famName}</span>
            </div>`;
        } else {
            // Optional: Add a small header for Individuals to separate them visually
            html += `<div class="family-header" style="background:#fff; color:#888; font-size:0.8rem;">
                        <span>Individual Members</span>
                     </div>`;
        }

        families[famName].forEach(p => {
            html += `
            <div class="member-row" onclick="togglePerson(this, '${famName}')">
                <span class="sno">${p.sno}</span>
                <div style="flex-grow: 1; display: flex; flex-direction: column;">
                    <span class="name-text">${p.name}</span>
                    <span class="info-sub" style="font-size: 11px; color: #888;">${p.ageGrp ? p.ageGrp : ''}</span>
                </div>
                <input type="checkbox" class="indiv-check" 
                       data-name="${p.name}" 
                       data-fam="${famName}" 
                       data-grp="${p.ageGrp}">
            </div>`;
        });

        html += `</div>`;
        area.innerHTML += html;
    });
}


    function selectFamily(famName, isChecked) {
        const checkboxes = document.querySelectorAll(`[data-fam="${famName}"]`);
        checkboxes.forEach(cb => cb.checked = isChecked);
    }

    function togglePerson(el, famName) {
        const cb = el.querySelector('.indiv-check');
        cb.checked = !cb.checked;
        
        // Uncheck family header if an individual is unchecked
        if (!cb.checked) {
            const safeId = famName.replace(/\s+/g, '');
            const master = document.querySelector(`#card-${safeId} .family-header input`);
            if (master) master.checked = false;
        }
    }

function copyAttendance() {
    const checkedBoxes = document.querySelectorAll('.indiv-check:checked');
    if (checkedBoxes.length === 0) return alert("Select names first!");

    // 1. Gather all selected data into an array
    let selected = Array.from(checkedBoxes).map(cb => ({
        name: cb.getAttribute('data-name'),
        fam: cb.getAttribute('data-fam'),
        grp: cb.getAttribute('data-grp') ? cb.getAttribute('data-grp').toUpperCase() : ""
    }));

    let finalNames = [];
    let uniqueFamilies = [...new Set(selected.map(p => p.fam))];

    uniqueFamilies.forEach(familyName => {
        let members = selected.filter(p => p.fam === familyName);
        
        // Separate Adults and Children
        let children = members.filter(m => m.grp === 'CHILD' || m.grp.includes('CHILD'));
        let adults = members.filter(m => m.grp !== 'CHILD' && !m.grp.includes('CHILD'));
        
        // String of child names
        let childText = children.length > 0 ? ` + (${children.map(c => c.name).join(" & ")})` : "";

        // Check availability of S and B
        let hasS = adults.find(a => a.grp === 'S');
        let hasB = adults.find(a => a.grp === 'B');

        adults.forEach(adult => {
            let entry = adult.name;

            // Logic: Attach child to S if S is checked
            if (adult.grp === 'S' && children.length > 0) {
                entry += childText;
            } 
            // Logic: If S is NOT checked, attach child to B
            else if (adult.grp === 'B' && !hasS && children.length > 0) {
                entry += childText;
            }
            
            finalNames.push(entry);
        });

        // Fallback: If children are checked but no B or S adults are checked
        if (adults.length === 0 && children.length > 0) {
            children.forEach(c => finalNames.push(c.name));
        }
    });

    // 2. Format final string for WhatsApp
    let loc = document.getElementById('locDrop').value;
    let date = document.getElementById('attDate').value;
    let text = `Attendance: ${loc}\nDate: ${date}\n\n`;
    
    finalNames.forEach((name, i) => {
        text += `${i + 1}. ${name}\n`;
    });

    // 3. Copy to clipboard
    navigator.clipboard.writeText(text).then(() => {
        alert("Copied with Smart Grouping!");
    });
}


</script>
</body>
</html>