<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bangalore Video Training Dashboard</title>
    <style>
        :root { 
            --primary: #003366; --bg: #f4f7f9; --border: #dee2e6; 
            --severity-3: #dc3545; /* Red */
            --severity-2: #fd7e14; /* Orange */
            --severity-1: #ffc107; /* Yellow */
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; margin: 0; padding-bottom: 40px; }
        header { background: linear-gradient(135deg, #003366 0%, #001a33 100%); color: white; padding: 25px; text-align: center; margin-bottom: 25px; }
        .container { max-width: 1400px; margin: auto; padding: 0 15px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 25px; overflow: hidden; }
        
        .stats-container { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
        .stat-box { flex: 1; min-width: 160px; background: white; padding: 20px; border-radius: 10px; text-align: center; border-bottom: 5px solid var(--border); }
        .stat-box h2 { margin: 10px 0 0 0; font-size: 32px; color: var(--primary); }

        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 600px; }
        th, td { padding: 12px 8px; border: 1px solid var(--border); text-align: center; }
        th { background: #f8f9fa; color: var(--primary); font-weight: bold; }
        .loc-col { text-align: left !important; font-weight: bold; background: #f0f4f8 !important; position: sticky; left: 0; z-index: 2; width: 120px; }

        /* Severity Badges */
        .badge { padding: 5px 10px; border-radius: 4px; font-weight: 800; font-size: 10px; text-transform: uppercase; color: white; display: inline-block; }
        .badge-red { background: var(--severity-3); } 
        .badge-orange { background: var(--severity-2); }
        .badge-yellow { background: var(--severity-1); color: #000; }
        
        /* Row Tinting */
        .row-red { background: #fff5f5 !important; } 
        .row-orange { background: #fffaf5 !important; }
        .row-yellow { background: #fffef0 !important; }

        @media (max-width: 600px) { .loc-col { width: 90px; } .stat-box h2 { font-size: 24px; } }
    </style>
</head>
<body>

<header>
    <h1>Bangalore Video Training Dashboard</h1>
    <p>Locality-Based Attendance Tracking</p>
</header>

<div class="container">
    <div id="status-box" style="text-align:center; background:#fff3cd; padding:10px; border-radius:5px;">üîÑ Loading Data...</div>

    <div class="card">
        <label style="font-weight: bold;">üìç Filter View by Location:</label>
        <select id="locationFilter" onchange="renderDashboard()" style="width:100%; padding:10px; margin-top:10px; border-radius:5px;">
            <option value="ALL">Show All Locations</option>
        </select>
    </div>

    <div class="stats-container">
        <div class="stat-box" style="border-color: var(--severity-3);"><p>Lates (L)</p><h2 id="stat-late">0</h2></div>
        <div class="stat-box" style="border-color: var(--severity-2);"><p>Missed (0)</p><h2 id="stat-missed">0</h2></div>
        <div class="stat-box" style="border-color: var(--primary);"><p>Data Errors</p><h2 id="stat-errors">0</h2></div>
    </div>

    <div class="card">
        <h3>1. Registered Trainee Counts</h3>
        <div class="table-wrapper"><table><thead><tr id="regHead"><th class="loc-col">Location</th></tr></thead><tbody id="regBody"></tbody></table></div>
    </div>

    <div class="card">
        <h3>2. Actual Presence (P+L)</h3>
        <div class="table-wrapper"><table><thead><tr id="attHead"><th class="loc-col">Location</th></tr></thead><tbody id="attBody"></tbody></table></div>
    </div>

    <div class="card" id="alertCard" style="display:none;">
        <h3>‚ö†Ô∏è Attendance Warning List</h3>
        <div class="table-wrapper">
            <table>
                <thead><tr><th>Severity</th><th>Name</th><th>Location</th><th>Lates</th><th>Missed</th></tr></thead>
                <tbody id="alertBody"></tbody>
            </table>
        </div>
    </div>

    <div class="card" id="errorCard" style="display:none;">
        <h3 style="color: var(--primary)">üìã Spreadsheet Data Errors</h3>
        <div class="table-wrapper"><table><thead><tr><th>Error</th><th>Trainee</th><th>Row</th><th>Details</th></tr></thead><tbody id="errorBody"></tbody></table></div>
    </div>
</div>

<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbyfKmVxslXo3mQttEIfbXPIkPH9nPAiqEqoihuu_tIQa7xGQih-jgBkJqZywB8UXxM37A/exec";
    let rawData = [], headers = [];

    for(let i=1; i<=12; i++) { 
        document.getElementById('regHead').innerHTML += `<th>M${i}</th>`; 
        document.getElementById('attHead').innerHTML += `<th>M${i}</th>`;
    }

    (function load() {
        const s = document.createElement('script');
        s.src = `${scriptURL}?callback=handleData&t=${Date.now()}`;
        document.body.appendChild(s);
    })();

    window.handleData = function(data) {
        if (!data) return;
        headers = data[0].map(h => String(h).trim().toUpperCase());
        rawData = data.slice(1);
        const locIdx = headers.indexOf("LOCATION");
        [...new Set(rawData.map(row => row[locIdx]).filter(l => l))].sort().forEach(loc => {
            document.getElementById('locationFilter').innerHTML += `<option value="${loc}">${loc}</option>`;
        });
        document.getElementById('status-box').style.display = "none";
        renderDashboard();
    };

    function renderDashboard() {
        const sel = document.getElementById('locationFilter').value;
        const nIdx = headers.indexOf("NAMES"), lIdx = headers.indexOf("LOCATION"), pIdx = headers.indexOf("PT MESSAGES");
        
        let stats = { late: 0, missed: 0 };
        let locReg = {}, locAtt = {}, alertList = [], dataErrors = [], seen = {};
        
        let completedSessions = {}; 
        rawData.forEach(row => {
            const loc = String(row[lIdx] || "").trim();
            if (!loc) return;
            if (!completedSessions[loc]) completedSessions[loc] = {};
            for (let i = 1; i <= 12; i++) {
                const val = String(row[headers.indexOf("M"+i)] || "").trim();
                if (val !== "") completedSessions[loc][i] = true;
            }
        });

        rawData.forEach((row, idx) => {
            const name = String(row[nIdx] || "").trim(), loc = String(row[lIdx] || "").trim(), pt = String(row[pIdx] || "").toUpperCase();
            if (!name) return;

            if (!loc) dataErrors.push({ t: "No Location", n: name, r: idx+2, d: "Missing center name" });
            if (!pt) dataErrors.push({ t: "No Registration", n: name, r: idx+2, d: "No messages selected" });
            if (seen[name.toUpperCase()]) dataErrors.push({ t: "Duplicate", n: name, r: idx+2, d: "Name exists twice" });
            seen[name.toUpperCase()] = true;

            if (!loc || (sel !== "ALL" && loc !== sel)) return;
            if (!locReg[loc]) { locReg[loc] = Array(13).fill(0); locAtt[loc] = Array(13).fill(0); }

            let lates = [], missed = [];
            for (let i = 1; i <= 12; i++) {
                const isReg = pt.includes("ALL") || pt.split(',').map(s=>s.trim()).includes(String(i));
                const val = String(row[headers.indexOf("M"+i)] || "").trim().toUpperCase();

                if(isReg) locReg[loc][i]++;
                if (val === "1" || val === "L") {
                    locAtt[loc][i]++;
                    if (val === "L") { lates.push("M"+i); stats.late++; }
                } else if (isReg && (val === "0" || val === "") && completedSessions[loc][i]) {
                    missed.push("M"+i); stats.missed++;
                }
            }

            const totalIssues = lates.length + missed.length;
            if (totalIssues > 0) {
                let colorClass = 'yellow';
                if (totalIssues === 2) colorClass = 'orange';
                if (totalIssues >= 3) colorClass = 'red';

                alertList.push({ name, loc, colorClass, lates: lates.join(","), missed: missed.join(",") });
            }
        });

        const drawTable = (dataMap) => {
            return Object.keys(dataMap).sort().map(l => {
                let rData = dataMap[l].slice(1);
                return `<tr><td class="loc-col">${l}</td>${rData.map(c => `<td>${c}</td>`).join('')}<td style="font-weight:bold">${rData.reduce((a,b)=>a+b,0)}</td></tr>`;
            }).join('');
        };

        document.getElementById('regBody').innerHTML = drawTable(locReg);
        document.getElementById('attBody').innerHTML = drawTable(locAtt);
        document.getElementById('stat-late').innerText = stats.late;
        document.getElementById('stat-missed').innerText = stats.missed;
        document.getElementById('stat-errors').innerText = dataErrors.length;
        
        document.getElementById('alertCard').style.display = alertList.length ? 'block' : 'none';
        document.getElementById('alertBody').innerHTML = alertList.map(t => {
            return `<tr class="row-${t.colorClass}">
                <td><span class="badge badge-${t.colorClass}">WARNING</span></td>
                <td><b>${t.name}</b></td>
                <td>${t.loc}</td>
                <td>${t.lates || '-'}</td>
                <td>${t.missed || '-'}</td>
            </tr>`;
        }).join('');
        
        document.getElementById('errorBody').innerHTML = dataErrors.map(e => `<tr><td><b>${e.t}</b></td><td>${e.n}</td><td>${e.r}</td><td>${e.d}</td></tr>`).join('');
        document.getElementById('errorCard').style.display = dataErrors.length ? 'block' : 'none';
    }
</script>
</body>
</html>